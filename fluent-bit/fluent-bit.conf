# =============================================================================
# Fluent Bit Configuration for WAF Event Processing (Simplified)
# =============================================================================
#
# Architecture:
#   ModSecurity JSON logs → Fluent Bit (tail) → Kafka (single topic)
#   Track 분리, 분석/실시간 라우팅은 ksqlDB에서 처리
#
# =============================================================================

[SERVICE]
    Flush         5
    Daemon        off
    Log_Level     info
    Parsers_File  parsers.conf

    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020

# =============================================================================
# INPUT CONFIGURATION - ModSecurity Log Ingestion
# =============================================================================

[INPUT]
    Name              tail
    Path              /var/log/modsecurity/*.json
    Tag               waf.modsec
    Parser            json
    Refresh_Interval  5
    Read_From_Head    true

# =============================================================================
# FILTER CONFIGURATION - Basic Field Processing (GeoIP disabled for stability)
# =============================================================================

[FILTER]
    Name              modify
    Match             waf.modsec
    Add               processed_timestamp ${HOSTNAME}-${TIMESTAMP}

# Simple classification - use modify to add individual fields
[FILTER]
    Name              modify
    Match             waf.modsec
    Add               track analytics
    Add               rule_id ""
    
# NOTE: GeoIP2 filter disabled due to SIGSEGV issue
# Alternative: Use Logstash geoip filter for geographical enrichment
# [FILTER]
#     Name          geoip2
#     Match         waf.modsec
#     Database      /fluent-bit/etc/GeoLite2-City.mmdb
#     Lookup_key    transaction.client_ip
#     Record        country  country.iso_code
#     Record        city     city.names.en
#     Record        lat      location.latitude
#     Record        lon      location.longitude

# =============================================================================
# OUTPUT CONFIGURATION - Kafka (Unified Topic)
# =============================================================================

[OUTPUT]
    Name        kafka
    Match       waf.modsec
    Brokers     kafka:9092
    Topics      waf-realtime-events
    Format      json
    Retry_Limit 3
    